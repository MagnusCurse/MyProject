<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>blog_content</title>
    <link rel="stylesheet" href="css/conmmon.css">
    <link rel="stylesheet" href="css/blog_content.css">
    <link rel="stylesheet" href="editor.md/css/editormd.preview.min.css" />
    <script src="js/jquery.min.js"></script>
    <script src="editor.md/editormd.js"></script>
    <script src="editor.md/lib/marked.min.js"></script>
    <script src="editor.md/lib/prettify.min.js"></script>
    <!--引入jquery-->
    <script src="js/jquery.min.js"></script>
    <!--引入自己写的js工具包-->
    <script src="js/tool.js"></script>
</head>

<body>
    <!-- 导航栏 -->
    <div class="nav">
        <img src="img/d-logoblack.png" alt="">
        <span class="title"></span>
        <!-- 用来占据中间位置 -->
        <span class="spacer"></span>
        <a href="blog_list.html">主页</a>
        <a href="myblog_list.html">我的博客</a>
        <a href="blog_edit.html">创作</a>
        <!--a 标签 onclick 有些浏览器不生效,所以跳转写在href中,javascript表示后面的是js代码-->
        <a href="javascript:onExit()">注销</a>
        <!-- <a href="#">注销</a> -->
    </div>
    
    <!-- 版心 -->
    <div class="container">
        <!-- 左侧个人信息 -->
        <div class="container-left">
            <div class="card">
                <img :src="imageUrl" class="avtar" alt="" id="photo">

                <h3 id = "username"></h3>
                <a href="http:www.github.com">Github 地址</a>
                <div class="counter">
                    <span>文章</span>
                    <span>分类</span>
                </div>
                <div class="counter">
                    <span>2</span>
                    <span>1</span>
                </div>
            </div>
        </div>

        <!-- 右侧内容详情 -->
        <div class="container-right">
            <div class="blog-content">
                <!-- 博客标题 -->
                <h3 id = "title"></h3>
                <!-- 博客时间 -->
                <div class="date" id = "date"></div>
                <!-- 博客正文 -->
                <div id="editorDiv">

                </div>
                <!-- 评论区 -->
                <div class="comments">
                    <h3>评论区</h3>
                    <div class="comment-form">
                        <textarea placeholder="请输入评论" id="comment-box"></textarea>
                        <button id="submitCommentButton">提交</button>
                    </div>
                    <div class="comment-list" id="comment-list">


                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入 Vue 和 Axios -->
    <script src="js/vue.js"></script>
    <script src="js/axios.min.js"></script>
    <script src="js/MyJavaScript/initAvatar(curArticle).js"></script>

    <script type="text/javascript">
            var editormd;
            function initEdit(md){
                editormd = editormd.markdownToHTML("editorDiv", {
                markdown : md, // Also, you can dynamic set Markdown text
                // htmlDecode : true,  // Enable / disable HTML tag encode.
                // htmlDecode : "style,script,iframe",  // Note: If enabled, you should filter some dangerous HTML tags for website security.
                });
            }

            //根据用户初始化左侧个人信息
            function initMyInfo(){
                //发送ajxa给后端
                jQuery.ajax({
                 url: "/user/mycontentinfo",
                 type: "POST",
                 data: {
                    id: getURLParam("id")
                 },
                 success: function(result){
                    if(result != null && result.data != null){
                    jQuery("#username").text(result.data.username);
                    }
                 }
                });
            }
            initMyInfo();//页面渲染后即立刻加载                

            //根据文章ID初始化当前博客详情页面
            function initDetail(){
               var artId = getURLParam("id");
               //发送ajxa给后端
               jQuery.ajax({
                 url: "article/detail",
                 type: "POST",
                 data: {
                    id: artId//前面key的名字要和后端相同,这里不要加.val()
                },//通过该方法得到目前文章id发送给后端
                 success: function(result){
                    if(result != null && result.code == 200){
                    jQuery("#title").text(result.data.title);
                    jQuery("#date").text(result.data.date);
                    jQuery("#editorDiv").html(initEdit(result.data.content));
                    }
                  }
               });      
            }
            initDetail();//页面渲染后即立刻加载

            // //根据文章 ID 初始化评论列表
            // function initComment(){
            //     //发送ajax给后端
            //     jQuery.ajax({
            //         url: "/article/comment",
            //         type: "POST",
            //         data: {//获取 url 中的文章 id
            //            aid: getURLParam("id") 
            //         },
            //         success: function(result){
            //             <!--每一个评论包含评论用户,评论内容,以及评论日期-->
            //             var html = "";
            //             if(result.code == 200 && result.data != null && result.data.length > 0){
            //                 result.data.forEach(function(item){
            //                     html += '<div class="comment">' +  
            //                                '<div class="comment-author">' +  
            //                                   '<img src="img/avatar/default-image.png">' + 
            //                                   '<span class="username">' + item.username + '<span>' +
            //                                '</div>' + 
            //                                '<div class="comment-content">' + item.content + '</div>' +
            //                             '</div>'  
            //                 });
            //                 jQuery("#comment-list").html(html);
            //             }else{//目前没有用户发表评论
                            
            //             }
            //         }
            //     });
            // }
            // initComment();//页面渲染后立刻加载

            //  //发表评论功能
            //  function submitComment(){
            //     var content = jQuery("#comment-box");
            //     if(content.val() == ""){
            //         alert("请先输入评论!");
            //     }else{
            //        //发送ajxa给后端
            //        jQuery.ajax({
            //          url: "/article/submitcomment",
            //          type: "POST",
            //          data: {
            //             aid: getURLParam("id"),
            //             content: content.val(),
            //          },
            //          success: function(result){
            //             if(result.code == 200 && result.data == 1){
            //                 //重新刷新一下页面
            //                 location.reload(true);
            //             }else{
            //                 alert("发表评论失败");
            //             }
            //          }
            //        });
            //     }
            // }


    // 从后端获取评论数据数据
    function retrieveCommentsFromBackend() {
      // 发送 ajax 给后端
      jQuery.ajax({
         url : "/comment/search",
         type : "POST",
         data : {
            articleID : getURLParam("id")
         },
         success : function(result){
            if(result != null && result.code == 200){ // 初始化 comments 数组
                var comments = []; // 需要返回的 comments 数组
                var item = result.data; // 获取 List 对象
                for(var i = 0;i < item.length;i++){
                var comment = {
                    commentID : item[i].commentID,
                    parentCommentID : item[i].parentCommentID,
                    userID : item[i].userID,
                    content : item[i].content,
                    create_time : new Date(item[i].create_time),
                    likes : item[i].likes,
                    articleID : item[i].articleID
                }
                comments.push(comment);       
              }
              initializeComments(comments);
            }
          },
          error : function(result){
              alert("Something wrong! Please try again!!");
          }
       });
    }

    // 创建评论元素
    function createCommentElement(comment) {
      const commentDiv = document.createElement('div');
      commentDiv.className = 'comment';

      const userSpan = document.createElement('span');
      userSpan.innerText = comment.userID + ': '; // 
      commentDiv.appendChild(userSpan);

      const contentSpan = document.createElement('span');
      contentSpan.innerText = comment.content;
      commentDiv.appendChild(contentSpan);

      const replyButton = document.createElement('button');
      replyButton.innerText = 'reply';
      replyButton.addEventListener('click', function() {
        const replyText = prompt('Please Input the content of reply:');
        if (replyText) {
          const replyComment = { // 
            id: generateUniqueId(),
            parentId: comment.id,
            user: 'Current User',
            content: replyText,
            likes: 0,
          };
          const replyElement = createCommentElement(replyComment);
          const replyContainer = document.createElement('div');
          replyContainer.className = 'reply';
          replyContainer.appendChild(replyElement);
          commentDiv.appendChild(replyContainer);
        }
      });
      commentDiv.appendChild(replyButton);

      const likeButton = document.createElement('button');
      likeButton.innerText = 'Like';
      likeButton.addEventListener('click', function() {
        comment.likes++;
        likeButton.innerText = 'Like (' + comment.likes + ')';
      });
      commentDiv.appendChild(likeButton);

      return commentDiv;
    }

    // 递归构建评论和回复的层次结构
    function buildCommentTree(comments, parentCommentId, container) {
      const childComments = comments.filter(comment => comment.parentCommentID === parentCommentId); // 

      for (const comment of childComments) {
        const commentElement = createCommentElement(comment);
        container.appendChild(commentElement); 
        const replyContainer = document.createElement('div');
        replyContainer.className = 'reply';
        buildCommentTree(comments, comment.commentID, replyContainer); // 
        container.appendChild(replyContainer);
      }
    }

    // 生成唯一ID（示例中使用简单的自增ID）
    let commentIdCounter = 1;
    function generateUniqueId() {
      return commentIdCounter++;

      // 这里需要将新评论加入数据库


    }

    // 初始化评论区
    function initializeComments(comments) {
      const commentContainer = document.getElementById('comment-list');
      buildCommentTree(comments, null, commentContainer); // 
    }

    // 提交评论
    function submitComment() {
      const commentInput = document.getElementById('commentInput');
      const commentText = commentInput.value.trim();
      if (commentText) {
        const newComment = {
          id: generateUniqueId(),
          parentId: null,
          user: 'Current User',
          content: commentText,
          likes: 0,
        };
        const commentElement = createCommentElement(newComment);
        const commentContainer = document.getElementById('comment-list');
        commentContainer.appendChild(commentElement);
        commentInput.value = '';
      }

      // 这里也需要调用数据库将新的评论加入数据库中
    }

    // 在页面加载完成后调用获取评论数据函数
    window.addEventListener('DOMContentLoaded', retrieveCommentsFromBackend);

    // 在页面加载完成后调用初始化评论区函数
    window.addEventListener('DOMContentLoaded', initializeComments);

  
    // 绑定提交评论按钮的点击事件
    const submitCommentButton = document.getElementById('submitCommentButton');
    submitCommentButton.addEventListener('click', submitComment);
    </script> 
</body>
</html>